<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8" />
  <title>Medisch Verslag - iPhone Compatibel</title>
  <style>
    body { font-family: sans-serif; padding: 20px; max-width: 800px; margin: auto; }
    button { padding: 10px; font-size: 1em; margin-top: 10px; width: 100%; }
    .recording { background-color: red; color: white; }
    .stopping { background-color: blue; color: white; }
    textarea { width: 100%; min-height: 200px; margin-top: 10px; font-family: monospace; }
    .copy-button { margin-top: 5px; background: #444; color: white; border: none; padding: 8px 12px; cursor: pointer; }
  </style>
</head>
<body>
  <h1>ü©∫ Medisch verslag - iPhone vriendelijk</h1>

  <form method="post" action="/transcribe" enctype="multipart/form-data" id="uploadForm">
    <label for="verslag_type">Type verslag:</label>
    <select name="verslag_type">
      <option value="TTE">TTE</option>
      <option value="TEE">TEE</option>
      <option value="spoedconsult">Spoedconsult</option>
      <option value="raadpleging">Raadpleging</option>
    </select>

    <label>Upload audio:</label>
    <input type="file" name="audio_file" accept="audio/*" />

    <button type="submit">Upload en verwerk</button>
  </form>

  <h3>üéôÔ∏è Of dicteer rechtstreeks:</h3>
  <button id="recordBtn" onclick="toggleRecord()">üî¥ Start opname</button>
  <audio id="preview" controls style="margin-top:10px; display:none;"></audio>

  <form id="recordUploadForm" method="post" action="/transcribe" enctype="multipart/form-data" style="display:none;">
    <input type="hidden" name="verslag_type" value="TTE" />
    <input type="file" name="audio_file" id="recordedAudioInput" />
  </form>

  <h2>Verslag</h2>
  <textarea id="verslagText" readonly>{{ transcript }}</textarea>
  <button class="copy-button" onclick="copyVerslag()">üìã Kopieer verslag</button>

  <script>
    let recording = false;
    let mediaRecorder, chunks = [];

    function toggleRecord() {
      const btn = document.getElementById("recordBtn");

      if (!recording) {
        navigator.mediaDevices.getUserMedia({ audio: true }).then(stream => {
          mediaRecorder = new MediaRecorder(stream, { mimeType: "audio/webm" });
          chunks = [];

          mediaRecorder.ondataavailable = e => chunks.push(e.data);
          mediaRecorder.onstop = () => {
            const blob = new Blob(chunks, { type: "audio/webm" });
            const file = new File([blob], "dictaat_" + Date.now() + ".webm", { type: "audio/webm" });

            const preview = document.getElementById("preview");
            preview.src = URL.createObjectURL(blob);
            preview.style.display = "block";

            const fileInput = document.getElementById("recordedAudioInput");
            const dataTransfer = new DataTransfer();
            dataTransfer.items.add(file);
            fileInput.files = dataTransfer.files;

            document.getElementById("recordUploadForm").submit();
          };

          mediaRecorder.start();
          btn.textContent = "üîµ Stop opname";
          btn.className = "stopping";
          recording = true;
        }).catch(err => {
          alert("Fout bij toegang tot microfoon: " + err);
        });
      } else {
        mediaRecorder.stop();
        recording = false;
        const btn = document.getElementById("recordBtn");
        btn.textContent = "üî¥ Start opname";
        btn.className = "recording";
      }
    }

    function copyVerslag() {
      const text = document.getElementById("verslagText");
      text.select();
      document.execCommand("copy");
      alert("Verslag gekopieerd naar klembord.");
    }
  </script>
</body>
</html>
